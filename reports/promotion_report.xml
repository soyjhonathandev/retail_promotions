<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ====================================
         ACCIÓN DE REPORTE
         ==================================== -->
    
    <record id="action_promotion_report" model="ir.actions.report">
        <field name="name">Promotion Report</field>
        <field name="model">retail.promotion</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">retail_promotions.promotion_report_template</field>
        <field name="report_file">retail_promotions.promotion_report_template</field>
        <field name="binding_model_id" ref="model_retail_promotion"/>
        <field name="binding_type">report</field>
    </record>
    
    <!-- ====================================
         PLANTILLA DE REPORTE
         ==================================== -->
    
    <template id="promotion_report_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="promotion">
                <t t-call="web.external_layout">
                    <div class="page">
                        <!-- Header del reporte -->
                        <div class="row">
                            <div class="col-12">
                                <h2 class="text-center mb-4">
                                    <strong>Promotion Report</strong>
                                </h2>
                            </div>
                        </div>
                        
                        <!-- Información principal de la promoción -->
                        <div class="row">
                            <div class="col-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Code:</strong></td>
                                        <td><span t-field="promotion.code"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Name:</strong></td>
                                        <td><span t-field="promotion.name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>State:</strong></td>
                                        <td>
                                            <span t-field="promotion.state" class="badge"
                                                  t-attf-class="badge-#{promotion.state == 'active' and 'success' or promotion.state == 'expired' and 'danger' or 'secondary'}"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Valid:</strong></td>
                                        <td>
                                            <span class="badge" 
                                                  t-attf-class="badge-#{promotion.is_valid and 'success' or 'danger'}">
                                                <t t-if="promotion.is_valid">YES</t>
                                                <t t-else="">NO</t>
                                            </span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="col-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Start Date:</strong></td>
                                        <td><span t-field="promotion.start_date" t-options="{'widget': 'date'}"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>End Date:</strong></td>
                                        <td><span t-field="promotion.end_date" t-options="{'widget': 'date'}"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Days Remaining:</strong></td>
                                        <td><span t-field="promotion.days_remaining"/> days</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Usage:</strong></td>
                                        <td>
                                            <span t-field="promotion.current_usage"/>
                                            <t t-if="promotion.usage_limit > 0">
                                                / <span t-field="promotion.usage_limit"/>
                                            </t>
                                            <t t-else="">
                                                (unlimited)
                                            </t>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Información del descuento -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4>Discount Configuration</h4>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <p><strong>Discount Type:</strong> 
                                                   <span t-field="promotion.discount_type"/></p>
                                                <p t-if="promotion.discount_type == 'percentage'">
                                                    <strong>Discount:</strong> 
                                                    <span t-field="promotion.discount"/>%
                                                </p>
                                                <p t-if="promotion.discount_type == 'fixed'">
                                                    <strong>Fixed Discount:</strong> 
                                                    <span t-field="promotion.fixed_discount" 
                                                          t-options="{'widget': 'monetary', 'display_currency': promotion.currency_id}"/>
                                                </p>
                                            </div>
                                            <div class="col-6">
                                                <p t-if="promotion.minimum_amount > 0">
                                                    <strong>Minimum Amount:</strong> 
                                                    <span t-field="promotion.minimum_amount" 
                                                          t-options="{'widget': 'monetary', 'display_currency': promotion.currency_id}"/>
                                                </p>
                                                <p t-if="promotion.customer_limit > 0">
                                                    <strong>Customer Limit:</strong> 
                                                    <span t-field="promotion.customer_limit"/>
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <t t-if="promotion.description">
                                            <hr/>
                                            <p><strong>Description:</strong></p>
                                            <p t-field="promotion.description"/>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productos incluidos -->
                        <div class="row mt-4" t-if="promotion.product_ids">
                            <div class="col-12">
                                <h4>Included Products</h4>
                                <table class="table table-striped">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Code</th>
                                            <th>Name</th>
                                            <th>Category</th>
                                            <th>List Price</th>
                                            <th>Available Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="promotion.product_ids" t-as="product">
                                            <tr>
                                                <td><span t-field="product.default_code"/></td>
                                                <td><span t-field="product.name"/></td>
                                                <td><span t-field="product.categ_id.name"/></td>
                                                <td>
                                                    <span t-field="product.list_price" 
                                                          t-options="{'widget': 'monetary', 'display_currency': promotion.currency_id}"/>
                                                </td>
                                                <td><span t-field="product.qty_available"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Categorías incluidas -->
                        <div class="row mt-4" t-if="promotion.category_ids">
                            <div class="col-12">
                                <h4>Included Categories</h4>
                                <table class="table table-striped">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Category Name</th>
                                            <th>Parent Category</th>
                                            <th>Number of Products</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="promotion.category_ids" t-as="category">
                                            <tr>
                                                <td><span t-field="category.name"/></td>
                                                <td><span t-field="category.parent_id.name"/></td>
                                                <td><span t-field="category.product_count"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Footer con información adicional -->
                        <div class="row mt-5">
                            <div class="col-12">
                                <hr/>
                                <div class="text-center text-muted">
                                    <small>
                                        Report generated on <span t-esc="datetime.datetime.now().strftime('%d/%m/%Y %H:%M')"/>
                                        by <span t-esc="user.name"/>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
    
    <!-- ====================================
         REPORTE CONSOLIDADO DE PROMOCIONES
         ==================================== -->
    
    <record id="action_consolidated_promotions_report" model="ir.actions.report">
        <field name="name">Consolidated Promotions Report</field>
        <field name="model">retail.promotion</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">retail_promotions.consolidated_promotions_template</field>
        <field name="report_file">retail_promotions.consolidated_promotions_template</field>
    </record>
    
    <template id="consolidated_promotions_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="row">
                        <div class="col-12 text-center">
                            <h2><strong>Consolidated Promotions Report</strong></h2>
                            <p class="text-muted">
                                Generated on <span t-esc="datetime.datetime.now().strftime('%d/%m/%Y %H:%M')"/>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Resumen ejecutivo -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h4>Executive Summary</h4>
                            <div class="row">
                                <div class="col-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-success">
                                                <span t-esc="len(docs.filtered(lambda p: p.is_valid))"/>
                                            </h5>
                                            <p class="card-text">Valid</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-warning">
                                                <span t-esc="len(docs.filtered(lambda p: p.state == 'draft'))"/>
                                            </h5>
                                            <p class="card-text">Draft</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-danger">
                                                <span t-esc="len(docs.filtered(lambda p: p.state == 'expired'))"/>
                                            </h5>
                                            <p class="card-text">Expired</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-info">
                                                <span t-esc="sum(docs.mapped('current_usage'))"/>
                                            </h5>
                                            <p class="card-text">Total Usage</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabla de promociones -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h4>Promotion Details</h4>
                            <table class="table table-striped table-sm">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Discount</th>
                                        <th>Validity</th>
                                        <th>State</th>
                                        <th>Usage</th>
                                        <th>Products</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="docs" t-as="promotion">
                                        <tr>
                                            <td><span t-field="promotion.code"/></td>
                                            <td><span t-field="promotion.name"/></td>
                                            <td>
                                                <t t-if="promotion.discount_type == 'percentage'">
                                                    <span t-field="promotion.discount"/>%
                                                </t>
                                                <t t-else="">
                                                    $<span t-field="promotion.fixed_discount"/>
                                                </t>
                                            </td>
                                            <td>
                                                <span t-field="promotion.start_date" t-options="{'widget': 'date'}"/> - 
                                                <span t-field="promotion.end_date" t-options="{'widget': 'date'}"/>
                                            </td>
                                            <td>
                                                <span class="badge"
                                                      t-attf-class="badge-#{promotion.state == 'active' and 'success' or promotion.state == 'expired' and 'danger' or 'secondary'}">
                                                    <span t-field="promotion.state"/>
                                                </span>
                                            </td>
                                            <td>
                                                <span t-field="promotion.current_usage"/>
                                                <t t-if="promotion.usage_limit > 0">
                                                    / <span t-field="promotion.usage_limit"/>
                                                </t>
                                            </td>
                                            <td><span t-esc="len(promotion.product_ids)"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>
</odoo>ion.usos_actuales"/>
                                                <t t-if="promocion.limite_uso > 0">
                                                    / <span t-field="promocion.limite_uso"/>
                                                </t>
                                            </td>
                                            <td><span t-esc="len(promocion.product_ids)"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>
</odoo>